{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-4">

<!-- ðŸš¨ LOSS ALERT -->
<div id="lossAlert" class="alert alert-danger fw-bold d-none">
    ðŸš¨ Loss Alert: Some vehicles are running in loss
</div>

<!-- ================= FILTER BAR ================= -->
<div class="card shadow-sm border-0 mb-4 bg-light">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label fw-bold">Select Vehicle</label>
                <select id="vehicleFilter" class="form-select">
                    <option value="all">All Vehicles</option>
                    {% for s in summary %}
                        <option value="{{ s.vehicle|trim }}">{{ s.vehicle|trim }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">From Date</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">To Date</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button class="btn btn-primary w-100" onclick="applyFilter()">Apply</button>
                <button class="btn btn-outline-secondary" onclick="resetFilter()">Reset</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= SUMMARY CARDS ================= -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <small>Amount Received</small>
                <h4 id="cardAmountReceived">â‚¹{{ amount_received }}</h4>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <small>Total Cost</small>
                <h4 id="cardTotalCost">â‚¹0</h4>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <small>Balance</small>
                <h4 id="cardBalance">â‚¹0</h4>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <small>EV Cost</small>
                <h4>â‚¹ 6,980</h4>
            </div>
        </div>
    </div>
</div>

<!-- ================= CHARTS ================= -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">ðŸ“Š Monthly Revenue</div>
            <div class="card-body"><canvas id="monthlyRevenueChart"></canvas></div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">ðŸ“ˆ Date-wise Revenue</div>
            <div class="card-body"><canvas id="dateRevenueChart"></canvas></div>
        </div>
    </div>
</div>

<button class="btn btn-success mb-3" onclick="exportExcel()">ðŸ“¤ Export Excel</button>

<!-- ================= SUMMARY TABLE ================= -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">ðŸšš Vehicle Summary</div>
    <div class="table-responsive">
        <table class="table table-bordered" id="summaryTable">
            <thead>
                <tr>
                    <th>Vehicle</th>
                    <th>Driver Advance</th>
                    <th>Total Trip Cost</th>
                    <th>Amount Received</th>
                    <th>Total Cost</th>
                    <th>On Account</th>
                    <th>Balance</th>
                    <th>EV Cost</th>
                    <th>Pending</th>
                    <th>Revenue</th>
                </tr>
            </thead>
            <tbody>
                {% for s in summary %}
                <tr data-vehicle="{{ s.vehicle|trim }}" class="{% if s.revenue < 0 %}table-danger{% endif %}">
                    <td>{{ s.vehicle }}</td>
                    <td>{{ s.driver_advance }}</td>
                    <td>{{ s.total_trip_cost }}</td>
                    <td>{{ s.amount_received }}</td>
                    <td>{{ s.total_cost }}</td>
                    <td>{{ s.on_account }}</td>
                    <td>{{ s.balance }}</td>
                    <td>{{ s.ev_cost }}</td>
                    <td>{{ s.pending_balance }}</td>
                    <td class="fw-bold">{{ s.revenue }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ================= DETAIL TABLE ================= -->
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">ðŸ“‹ Expense Details</div>
    <div class="table-responsive" style="max-height:420px;">
        <table class="table table-sm table-striped" id="expenseTable">
            <thead class="table-dark sticky-top">
                <tr>{% for col in columns %}<th>{{ col }}</th>{% endfor %}</tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr data-vehicle="{{ row.VEHICLE_NO|trim }}" data-date="{{ row.DATE }}">
                    {% for col in columns %}<td>{{ row[col] }}</td>{% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const totalCardAmountReceived = parseAmount("{{ amount_received }}");

function parseAmount(v){ return Number(String(v).replace(/[^0-9.-]/g,''))||0; }

function applyFilter(){
    let vehicle = document.getElementById("vehicleFilter").value.trim();
    let start = document.getElementById("startDate").value;
    let end = document.getElementById("endDate").value;

    let remaining = totalCardAmountReceived;
    let totalCostSum = 0;
    let totalBalance = 0;

    document.querySelectorAll("#summaryTable tbody tr").forEach(tr=>{
        let show = vehicle==="all"||tr.dataset.vehicle===vehicle;
        tr.style.display = show?"":"none";

        if(show){
            let cost = parseAmount(tr.children[4].innerText);
            totalCostSum += cost;

            remaining -= cost;
            let balance = remaining;
            totalBalance += balance;

            tr.children[6].innerText = balance; // wallet-style
        }
    });

    // Card display
    document.getElementById("cardAmountReceived").innerText = "â‚¹" + totalCardAmountReceived;
    document.getElementById("cardTotalCost").innerText = "â‚¹" + totalCostSum;
    document.getElementById("cardBalance").innerText = "â‚¹" + remaining;

    checkLossAlert();
    buildMonthlyRevenueChart();
    buildDateRevenueChart();
}

function resetFilter(){
    document.getElementById("vehicleFilter").value="all";
    document.getElementById("startDate").value="";
    document.getElementById("endDate").value="";
    applyFilter();
}

function checkLossAlert(){
    let loss=false;
    document.querySelectorAll("#summaryTable tbody tr").forEach(tr=>{
        if(tr.style.display!=="none" && parseAmount(tr.children[9].innerText)<0) loss=true;
    });
    document.getElementById("lossAlert").classList.toggle("d-none",!loss);
}

function buildMonthlyRevenueChart(){drawChart("monthlyRevenueChart",true);}
function buildDateRevenueChart(){drawChart("dateRevenueChart",false);}
function drawChart(id,monthly){
    let map={};
    document.querySelectorAll("#expenseTable tbody tr").forEach(tr=>{
        if(tr.style.display==="none") return;
        let d = tr.dataset.date; if(!d) return;
        let key = monthly ? d.substr(3,5)+"-"+d.substr(6,8) : d;
        map[key] = (map[key]||0) + 1;
    });
    if(window[id]) window[id].destroy();
    window[id] = new Chart(document.getElementById(id),{
        type: monthly?"bar":"line",
        data: { labels:Object.keys(map), datasets:[{label:"Revenue", data:Object.values(map)}] }
    });
}

function exportExcel(){
    let wb = XLSX.utils.book_new(), data = [["Vehicle","Total Cost","Revenue"]];
    document.querySelectorAll("#summaryTable tbody tr").forEach(tr=>{
        if(tr.style.display==="none") return;
        data.push([tr.children[0].innerText, tr.children[4].innerText, tr.children[9].innerText]);
    });
    let ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Revenue");
    XLSX.writeFile(wb, "Revenue_Report.xlsx");
}

document.addEventListener("DOMContentLoaded", applyFilter);
</script>

{% endblock %}
